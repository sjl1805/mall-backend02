<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.CouponMapper">

    <resultMap id="BaseResultMap" type="com.example.model.entity.Coupon">
            <id property="id" column="id" jdbcType="BIGINT"/>
            <result property="name" column="name" jdbcType="VARCHAR"/>
            <result property="type" column="type" jdbcType="TINYINT"/>
            <result property="value" column="value" jdbcType="DECIMAL"/>
            <result property="minAmount" column="min_amount" jdbcType="DECIMAL"/>
            <result property="startTime" column="start_time" jdbcType="TIMESTAMP"/>
            <result property="endTime" column="end_time" jdbcType="TIMESTAMP"/>
            <result property="status" column="status" jdbcType="TINYINT"/>
            <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
            <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,name,type,
        value,min_amount,start_time,
        end_time,status,create_time,
        update_time
    </sql>

    <!-- 优惠券分页查询 -->
    <select id="selectCouponPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM coupon
        <where>
            <if test="query.status != null">
                status = #{query.status}
            </if>
            <if test="query.name != null and query.name != ''">
                AND name LIKE CONCAT('%', #{query.name}, '%')
            </if>
            <if test="query.startTime != null">
                AND start_time >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND end_time &lt;= #{query.endTime}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 优惠券状态批量更新 -->
    <update id="updateStatusBatch">
        UPDATE coupon
        SET status = #{status},
            update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 优惠券有效期更新 -->
    <update id="updateValidity">
        UPDATE coupon
        SET start_time = #{startTime},
            end_time = #{endTime},
            update_time = NOW()
        WHERE id = #{couponId}
    </update>

    <!-- 用户可用优惠券查询 -->
    <select id="selectAvailableCoupons" resultMap="BaseResultMap">
        SELECT c.*
        FROM coupon c
        WHERE c.status = 1
          AND NOW() BETWEEN c.start_time AND c.end_time
          AND c.min_amount &lt;= #{orderAmount}
    </select>

    <!-- 优惠券使用统计 -->
    <select id="selectUsageStatistics" resultType="map">
        SELECT 
            COUNT(*) AS total_count,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS used_count,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS unused_count
        FROM coupon
        WHERE type = #{couponType}
    </select>
</mapper>
